# Introduction

The original data files which are used the scripts are stored in [this google drive folder](https://drive.google.com/open?id=11rStbOup5DFmHP8FQOe_KCOSkXJIwXx0) which can be accessed within INBO.   

# Generation of table with all mhq samples 

The mhq samples (ref) were stored in different files. Here we will generate one standardized table containing all mhq samples including legacy sites. Legacy sites are existing samples that were included in mhq.

The table contains: 

* characteristics of the sample:
** sample_id
** location_id
** legacy_site: TRUE/FALSE
** xy-coordinates in Lambert72 (crs = 31370)
** type: the target type, i.e. the type for which the sample was drawn
** main_type: the main type of the target type

* characteristics of sample design
** grts-ranking
** year_planned: the monitoring cycle is 12 years and the sample is divided in 12 subsets according to the grts-ranking (one subset for each year in the monitoring cycle)
** sac (special area of conservation): TRUE/FALSE; a stratefied sample design was used with a higher sample size within sac

* charachteristics of the sample frame (see [n2khab-package](https://inbo.github.io/n2khab/reference/read_habitatmap_stdized.html) for explanation on the variables below)
** polygon_id
** phab
** certain
** description_orig

Note that the mhq sample selection is based on an older version of the habitat map than the versions made available in [Zenodo](https://zenodo.org/record/3540576#.XoRkVYgzaUk). The sample frame which is derived from the older version of the habitat map is stored in [this google drive folder](https://drive.google.com/open?id=11rStbOup5DFmHP8FQOe_KCOSkXJIwXx0) which can be accessed within INBO.  

Following table gives an overview of all mhq-schemes.

```{r schemes}

types <- read_types() %>%
    select(main_type, type, type_shortname, typeclass_name)

schemes_mhq <- read_scheme_types() %>%
    select(scheme, type) %>%
    filter(str_sub(scheme, 1, 2) == "HQ") %>%
    left_join(types, by = "type")

schemes_mhq %>%
    kable() %>%
    kable_styling()

```

## Data sources

## Read original sampleframe

```{r}

sampleframe_sf <- read_sf("../../n2khab_mhq_data/original/sample/sampleframe", "BWK_hab_ter_SBZH_versie20140324", crs = 31370) %>%
    select(Pol_ID)

sampleframe_types_orig <- read.table("../../n2khab_mhq_data/original/sample/sampleframe/BWK_habsubt_versie20140324.txt", stringsAsFactors = FALSE)

sampleframe_types <- sampleframe_types_orig %>%
    select(Pol_ID, phab, habsubt)
```


## Read original files with mhq samples

### Habitat 6510

```{r}

sample_6510_orig <- read_sf("../../n2khab_mhq_data/original/sample/sample-locations/6510_hab", "steekproef_6510_versie20140506", crs =31370, quiet = TRUE) 

sample_6510 <- sample_6510_orig %>%
    st_drop_geometry() %>%
    left_join(sampleframe_types, by = c("Pol_ID", "habsubt")) %>%
    select(id = ID, polygon_id = Pol_ID, grts_ranking = Ranking, x, y, main_type = habt, type = habsubt, phab, sac = SBZH, year_planned = year, description_orig = Pol_beschr) %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           legacy_site = FALSE,
           polygon_id = as.character(polygon_id),
           certain = !str_detect(description_orig, str_c(type,",")))
           
check_unique_id <- nrow(sample_6510) == n_distinct(sample_6510$id)

```

### Heath habitats

```{r}

sample_heath_orig <- read_sf("../../n2khab_mhq_data/original/sample/sample-locations/heide_hab", "meetnet_heide_versie201400611", crs =31370, quiet = TRUE) 

sample_heath <- sample_heath_orig %>%
    st_drop_geometry() %>%
    left_join(sampleframe_types, by = c("Pol_ID", "habsubt")) %>%
    select(id = ID, polygon_id = Pol_ID, grts_ranking = Ranking, x, y, main_type = habt, type = habsubt, phab, sac = SBZH, year_planned = year, description_orig = Pol_beschr) %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           legacy_site = FALSE,
           polygon_id = as.character(polygon_id),
           certain = !str_detect(description_orig, str_c(type,",")))

check_unique_id <- nrow(sample_heath) == n_distinct(sample_heath$id)

```

### Forest habitats: extra samples

```{r}

sample_forest_orig <- read_sf("../../n2khab_mhq_data/original/sample/sample-locations/bos_hab", "meetnet_bos_versie20150303", crs =31370, quiet = TRUE) 

sample_forest <- sample_forest_orig %>%
    st_drop_geometry() %>%
    left_join(sampleframe_types, by = c("Pol_ID", "habsubt")) %>%
    select(id = ID, polygon_id = Pol_ID, grts_ranking = Ranking, x, y, main_type = habt, type = habsubt, phab, sac = SBZH, year_planned = year, description_orig = Pol_beschr) %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           legacy_site = FALSE,
           polygon_id = as.character(polygon_id),
           certain = !str_detect(description_orig, str_c(type,",")))

sample_forest_new <- sample_forest %>%
    filter(!(type %in% c("2180", "91E0_sf")))

check_unique_id <- nrow(sample_forest_new) == n_distinct(sample_forest_new$id)
```

### Grassland habitat (excluding 6510) and marshes

```{r}

sample_grassland_marshes_orig <- read_sf("../../n2khab_mhq_data/original/sample/sample-locations/grasland-moeras_hab", "meetnet_graslandEnCo_versie20150303", crs =31370, quiet = TRUE) 

sample_grassland_marshes <- sample_grassland_marshes_orig %>%
    st_drop_geometry() %>%
    left_join(sampleframe_types, by = c("Pol_ID", "habsubt")) %>%
    select(id = ID, polygon_id = Pol_ID, grts_ranking = Ranking, x, y, main_type = habt, type = habsubt, phab, sac = SBZH, year_planned = year, description_orig = Pol_beschr) %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           legacy_site = FALSE,
           polygon_id = as.character(polygon_id),
           certain = !str_detect(description_orig, str_c(type,",")))

check_unique_id <- nrow(sample_grassland_marshes) == n_distinct(sample_grassland_marshes$id)
```

### Coastal dunes

This sample set is a mix of legacy sites (with known types) and new samples. Legacy sites were uneavenly spread among regions and management types. Therefore an new grts-sample set was drawn and we allowed a new sample to be replaced with a legacy site (with the same type as the sample) within a unit with a unique combination of region and management type. This way we could partially use the available legacy sites and remain a spatially balanced sample as much as possible. When a grts-sample was replaced with a legacy site, the legacy site inherited the grts-ranking (but the legacy site might be located in an other grts grid cell). As sample selection is performed for each type separately, it occured that the same grts-location was selected as a sample for one type and replaced with a legacy site for another type. In this case both samples will have the same grts-ranking but will not be in the same location. To make a unique location id we added '_reloc1' or 'reloc2' to the grts-ranking when a sample was replaced with a legacy site. 

Should we add an additional variable to explicitely that the grts-ranking does not correspond with the actual location but was inherited?

```{r}

sample_dunes_orig <- read.csv2("../../n2khab_mhq_data/original/sample/sample-locations/kustduinen_hab/steekproef_duinen_tabel_versie2018-11-2018.csv",
                               stringsAsFactors = FALSE) 

sample_dunes <- sample_dunes_orig %>%
    filter(Steekproef == 1) %>%
    group_by(Ranking, TypePQ) %>%
    mutate(i = rank(Habsubt)) %>%
    ungroup() %>%
    mutate(legacy_site = TypePQ == "PINK_PQ",
           ID = ifelse(legacy_site, ID, str_c(Ranking, Habsubt, sep = "_")),
           location_id = ifelse(TypePQ == "PINK_PQ", str_c(as.character(Ranking), "_reloc", i), as.character(Ranking))) %>% 
    select(id = ID, location_id, polygon_id = Pol_ID, grts_ranking = Ranking, x, y, main_type = Habt, type = Habsubt, phab = Phab, sac = SBZH, year_planned = Jaar, description_orig = Pol_beschrijving, legacy_site)  %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           certain = ifelse(is.na(description_orig), 
                            TRUE,
                            !str_detect(description_orig, str_c(type,",")))) 

check_unique_id <- nrow(sample_dunes) == n_distinct(sample_dunes$id)

```


### MONEOS legacy sites for 91E0_sf

The sample for 91E0_sf currently only consist of legacy sites. The legacy sites were randomly selected and could therefore be used in mhq. For each legacy site the grts-ranking of the gric-cell in which it is located was determined based on the master grts. However, as for all legacy sites, the selection of the sample is not based on this grts-ranking as the selection was done before the master grts existed. Furthermore, the legacy sites are not located in the grid cell centers as is the case for most of the newly selected samples.

Besides the legacys sites, a set of additional samples were selected based on the grts-ranking. However this selection still has to be evaluated in terms of accessability, as large parts of 91E0_sf are not accessable.

```{r}
sac_map <- read_admin_areas(dsn = "sac") %>%
    select(sac_code)

grts_master <- read_GRTSmh()

sample_91E0_sf_orig <- read_sf("../../n2khab_mhq_data/original/sample/sample-locations/91E0_sf_hab", "PQ_91E0_sf_MONEOS_versie2018-04-16", crs =31370, quiet = TRUE) 

sample_91E0_sf <- sample_91E0_sf_orig %>%
    mutate(grts_ranking = grts_master[as(., "Spatial")]) %>%
        st_join(sac_map) %>%
    st_drop_geometry() %>%
    mutate(type = "91E0_sf",
           main_type = "91E0",
           legacy_site = TRUE,
           x = st_coordinates(sample_91E0_sf_orig)[,1],
           y = st_coordinates(sample_91E0_sf_orig)[,2]) %>%
    mutate(x = round(x, 1),
           y = round(y, 1),
           main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           phab = 100,
           certain = TRUE,
            sac = ifelse(is.na(sac_code), 0, 1)) %>%
    select(id = NummerPQ,  x, y, main_type, type, legacy_site, sac, grts_ranking, phab, certain)

check_unique_id <- nrow(sample_91E0_sf) == n_distinct(sample_91E0_sf$id)

```


### Legacy sites Flemish forest inventory

The Flemish forest inventory (VBI) consists of random systematic sample on a 500m x 1000m grid covering the whole of Flanders. The VBI samples are measured in the same way as the mhq forest type samples and can therefore be used in mhq. However, until recently the habitat type of the VBI samples was not determined. Therefore we have to assume that the type corresponds to the habitatmap. We make an overlay between VBI samples an [habitatmap_terr](https://zenodo.org/record/3540740) and we select all VBI samples that are located in polygons with at least a phab >= 50 for a forest type. Since 2020 (the start of the 3rd monitoring cycle), the type of vbi samples are determined in situ.


```{r Bos selectieplots}

#VBI-Plot 138020 nakijken: heeft twee verschillende XY-coördinaten.

habitatmap <- read_habitatmap_terr()
habitatmap_pol <- habitatmap$habitatmap_terr_polygons
habitatmap_type <- habitatmap$habitatmap_terr_types

### VBI-plots die opgemeten werden in 2de cyclus

dbVBIMeetproces <- "../../n2khab_mhq_data/original/sample/sample-locations/bos_hab_vbi/VBI_Meetproces_v2019-02-20.accdb"

connectionMeetproces <- odbcConnectAccess2007(dbVBIMeetproces)

recordsVBI2 <- sqlFetch(connectionMeetproces, "tblRecordsVBI2+")
plotCordinates <- sqlFetch(connectionMeetproces,"tblCoordinaten")
plotDetails <- sqlFetch(connectionMeetproces,"tblPlotDetails")

odbcClose(connectionMeetproces)

# Plot 138020 heeft twee opgemeten coördinaten: we selecteren er één van: nog nakijken welke de juiste coördinaten zijn

plotCordinates2 <- plotCordinates %>%
    mutate(IDPlots = as.character(IDPlots)) %>%
    group_by(IDPlots) %>%
    slice(1) %>%
    ungroup()
 
plotDetails <- plotDetails  %>%
    mutate(IDPlots = as.character(IDPlots)) 

sample_vbi2 <- plotDetails %>%
    filter(Periode == 2) %>%
    left_join(plotCordinates2, by = c("IDPlots")) %>%
    mutate(x = ifelse(is.na(X_measuredVBI2), X_raster, X_measuredVBI2),
           y = ifelse(is.na(Y_measuredVBI2), Y_raster, Y_measuredVBI2),
           coord_measured = is.na(X_measuredVBI2)) %>% 
    select(IDPlots, DateVeg, DateDendro, IDGroup, x, y, coord_measured) 

sample_vbi2_sf <- st_as_sf(sample_vbi2, coords = c("x", "y"), crs = 31370)

sample_vbi2_type <- sample_vbi2_sf %>%
    mutate(grts_ranking = grts_master[as(., "Spatial")]) %>%
    st_join(sac_map) %>%
    st_join(habitatmap_pol) %>%
    st_drop_geometry() %>%
    left_join(habitatmap_type, by = "polygon_id") %>%
    filter(!is.na(phab)) %>%
    filter(phab >= 50) %>%
    filter(str_sub(type, end = 1) == "9" | type == "2180") %>%
    filter(type != "91E0_sf") %>%
    left_join(plotCordinates2, by = c("IDPlots")) %>%
    mutate(x = ifelse(is.na(X_measuredVBI2), X_raster, X_measuredVBI2),
           y = ifelse(is.na(Y_measuredVBI2), Y_raster, Y_measuredVBI2),
           coord_measured = is.na(X_measuredVBI2),
           legacy_site = TRUE,
           id = str_c("VBI_",IDPlots, "_", type),
           main_type = str_sub(type, end = 4),
           main_type = factor(main_type, levels = levels(types$main_type)),
           x = round(x, 1),
           y = round(y, 1),
           polygon_id = as.character(polygon_id),
           sac = ifelse(is.na(sac_code), 0, 1)) %>%
    select(id,  polygon_id, grts_ranking, phab, x, y, main_type, type, certain, description_orig, legacy_site, sac)

check_unique_id <- nrow(sample_vbi2_type) == n_distinct(sample_vbi2_type$id)

check <- sample_vbi2_type %>%
    group_by(id) %>%
    mutate(n = n()) %>%
    ungroup()

```

```{r}

```

### MONEOS legacy sites for 1330_da

For the plots with following id's only the coordinates of one of the corners is available: ZSCPQ303, ZSCPQ306, ZSCPQ307 en ZSCPQ314. The coordinates of the opposite corner will be measured soon so that we can calculate the coordinates of the plot center.

```{r}
sample_1330_da_orig <- read.csv2("../../n2khab_mhq_data/original/sample/sample-locations/1330_da_hab/Structuurgegevens_1330_da.csv", stringsAsFactors = FALSE)

coord_1330_da_orig <- read.csv2("../../n2khab_mhq_data/original/sample/sample-locations/1330_da_hab/coördinaten_1330_da.csv", stringsAsFactors = FALSE)

coord_1330_da <- coord_1330_da_orig %>%
    select(id, x = Lambert_X_mean, y = Lambert_Y_mean)

sample_1330_da <- sample_1330_da_orig %>%
    gather( starts_with("ZSCPQ"), key = "IDPlots", value =  "Waarde") %>%
    select(id = IDPlots, main_type = Habitattype, type = Habitatsubtype) %>%
    distinct() %>%
    mutate(main_type = factor(main_type, levels = levels(types$main_type)),
           type = factor(type, levels = levels(types$type)),
           legacy_site = TRUE,
           phab = 100,
           sac = 1,
           certain = TRUE) %>%
    left_join(coord_1330_da, by = "id")

sample_1330_da_sf <- st_as_sf(sample_1330_da, coords = c("x", "y"), crs = 31370)

sample_1330_da_grts <- sample_1330_da_sf %>%
    mutate(grts_ranking = grts_master[as(., "Spatial")]) %>%
    st_join(sac_map) %>%
    st_join(habitatmap_pol) %>%
    st_drop_geometry() %>%
    left_join(coord_1330_da, by = "id") %>%
    mutate(polygon_id = as.character(polygon_id)) %>%
    select(id,  polygon_id, grts_ranking, phab, x, y, main_type, type, certain, description_orig, legacy_site, sac)

#write.csv2(select(sample_1330_da, id), "../../output/meetpunten_1330_da.csv", row.names = FALSE)

check_unique_id <- nrow(sample_1330_da) == n_distinct(sample_1330_da$id)

```

### Combine files

```{r}
samples <- bind_rows(
    sample_6510,
    sample_grassland_marshes,
    sample_dunes,
    sample_heath,
    sample_forest_new,
    sample_vbi2_type,
    sample_91E0_sf,
    sample_1330_da_grts
) %>%
    mutate(location_id = ifelse(is.na(location_id), as.character(grts_ranking), location_id)) %>%
    arrange(type, grts_ranking) %>%
    select(sample_id = id, location_id, everything())

write_vc(samples, file = "mhq_terr_samples", root = "../../n2khab_mhq_data", sorting = c("type", "sample_id"), strict = FALSE)

```
