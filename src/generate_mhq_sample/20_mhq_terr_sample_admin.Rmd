# Generate mhq sample administration table

In the mhq sample adminstration table we want to document assessments and measurements of the mhq samples. An assessment of a mhq sample is seen as evaluation whether or not a sample is valid. A mhq sample is valid if the target type (= the type for which the sample was selected) corresponds with the observed type in the center of the grid cell. A location can contain different samples, with each sample having a different target type. This is the case when the sample frame of the different target types overlap. However, only one of the samples on a single location can be valid, as only one type can be observed in a location. Two types of assessments occur: in situ assessment and othophoto assessment. Based on othophoto assessment we can detect samples that are not valid (for example when a heath sample is located within a forest), but an in situ assessment is required to be sure that a sample is valid. In some cases locations are temporary or permanently inaccessable and assessments are not possible. We will summarise the assessment status using following categories:

* in situ assessment,
* orthophoto assessment,
* permanently inaccessable,
* temporary inaccessable,
* no assessment.

After assessment, a location is measured when one of the samples which it contains is valid. The measurements consist of a vegetation composition in a square plot (of 3m x 3m for open types and 16m x 16m for forest types) and structure variables in a circle plot (with a radius of 18m). INBO also measures vegetation composition in the circle plot, but ANB does not do this. 

In certain conditions, a location can also be measured when the observed type is different than one of the target types for this location (and consequently none of the samples are valid). This is allowed when the grts-ranking of the location is smaller than the maximum grts-ranking in the sample set for the observed type. It occurs when the sample frame of the observed type is not correct and excludes the location mentioned above. When this is the case we will create a new (valid) sample for this location with the appropriate target type. This new sample will replace the sample in the original sample set with the highest grts-ranking.                 

The detection rate of some types is very low. Therefore in some cases we allow changing the location of a sample in the direct surrounding (based on a protocol) in order to make it a valid sample. The sample administration table will also document these location changes. Finally we will also document wether measurements are complete or wether some variables are missing in the database.  

## Read INBO sample administration data 

INBO documents the administration of mhq sample assessments in separate files. From this file we van determine the assessment status, the assessment year, wether a location is measured and wether a location is changed. There is one file for grassland (excluding 6510) and marsh types and one file for coastal dune types. Later we will propose a standardised file for all mhq samples.  

### Grassland habitat (excluding 6510) and marshes

This file originally contains one record for each sample. However it is more convenient and it avoids conflicts when assessment status and measurement status is documented on the location level. It is a location can only have one assessment status or measurement status. Therefore we convert the file to a table with one record for each location (that contains samples). For this we create a location id which corresponds to the grts-ranking of the location.  

```{r}

#Voor sample 2388102_6230_hn moet NoAccess op 1 gezet worden en opname op nee.

admin_inbo_grassland_marshes_orig <- read.csv2("../../n2khab_mhq_data/original/admin/inbo/gras_moeras_2019.csv") 

admin_inbo_grassland_marshes_correct <- admin_inbo_grassland_marshes_orig %>%
    mutate(NoAccess = ifelse(ID == "2388102_6230_hn", 1, NoAccess),
           opname = ifelse(ID == "2388102_6230_hn", "nee", opname))

admin_inbo_grassland_marshes <- admin_inbo_grassland_marshes_correct %>%
    mutate(NoAccess = ifelse(ID == "2388102_6230_hn", 1, NoAccess)) %>%
    mutate(assessment_status = ifelse(bezocht > 1000, "in situ assessment", "no assessment"),
           assessment_status = ifelse(NoAccess == 1 & !is.na(NoAccess), "permanently inaccessable", assessment_status),
           assessment_status = ifelse(OrthoContr == 1 & !is.na(OrthoContr), "orthophoto assessment", assessment_status),
           assessment_status = factor(assessment_status, levels = c("in situ assessment", "orthophoto assessment", "no assessment", "inaccessable")),
           measured = opname == "ja",
           location_change = verplaatst == "ja",
           assessment_year = ifelse(assessment_status %in% c("in situ assessment", "orthophoto assessment"), bezocht, NA),
           # assessment_year = ifelse(assessment_year == 19, 2019, assessment_year),
           x_measured = ifelse(measured, round(POINT_X, 1), NA),
           y_measured = ifelse(measured, round(POINT_Y, 1), NA)) %>%
    select(sample_id = ID, grts_ranking = Ranking, assessment_status, assessment_year, measured, location_change, x_measured, y_measured)

check <- n_distinct(admin_inbo_grassland_marshes$sample_id) == nrow(admin_inbo_grassland_marshes)

check <- admin_inbo_grassland_marshes %>%
    filter(assessment_status == "in situ assessment" & is.na(measured))


check_different_dates <- admin_inbo_grassland_marshes %>%
    group_by(grts_ranking) %>%
    mutate(n_assess = n_distinct(assessment_status, assessment_year)) %>%
    ungroup() %>%
    filter(n_assess > 1) %>%
    arrange(grts_ranking)
    
write.table(check_different_dates, "../../output/check_different_dates.txt", row.names = FALSE)

```


```{r}

check_different_dates %>%
    kable() %>%
    kable_styling()
    
```


```{r}
#admin data for each location

admin_inbo_grassland_marshes_location <- admin_inbo_grassland_marshes %>%
    mutate(location_id = as.character(grts_ranking)) %>%
    group_by(location_id, grts_ranking) %>%
    mutate(assessment_status_loc = ifelse("inaccessable" %in% assessment_status, "inaccessable",
                                      ifelse("in situ assessment" %in% assessment_status, "in situ assessment",
                                             ifelse("orthophoto assessment" %in% assessment_status, "orthophoto assessment","no asessment")))) %>%
    ungroup() %>%
    group_by(location_id, grts_ranking, assessment_status_loc) %>%
    summarise(assessment_year = max(assessment_year, na.rm = TRUE),
              measured = any(measured),
              location_change = sum(location_change) > 0,
              x_measured = x_measured[1],
              y_measured = y_measured[1]) %>%
    ungroup() %>%
    mutate(assessment_year = ifelse(assessment_year == -Inf, NA, assessment_year)) %>%
    rename(assessment_status = assessment_status_loc) 

n_distinct(admin_inbo_grassland_marshes_location$location_id) == nrow(admin_inbo_grassland_marshes_location)
```

### Coastal dunes

This file contains one record for each location. However, the grts-ranking is not sufficient to uniquely identify each location. This can be explained as follows. 

```{r}
admin_inbo_dunes_orig <- read.csv2("../../n2khab_mhq_data/original/admin/inbo/duinen_2019.csv") 

admin_inbo_dunes <- admin_inbo_dunes_orig %>%
    group_by(Ranking) %>%
    mutate(n = n()) %>%
    ungroup() %>%
     mutate(assessment_status = ifelse(bezocht %in% c(2010:2100), "in situ assessment", "no assessment"),
           measured = opname == "ja",
           location_change = verplaatst == "ja",
           x_measured = ifelse(measured, round(POINT_X, 1), NA),
           y_measured = ifelse(measured, round(POINT_Y, 1), NA),
           assessment_year = ifelse(assessment_status %in% c("in situ assessment", "orthophoto assessment"), bezocht, NA),
          ) %>%
    select(TypePQ, grts_ranking = Ranking, assessment_status, assessment_year, measured, location_change, x_measured, y_measured, starts_with("F")) %>%
    gather(starts_with("F"), key = "Ftype", value = "target") %>%
    filter(target == 1) %>%
    group_by(grts_ranking, TypePQ) %>%
    mutate(i = rank(Ftype)) %>%
    ungroup() %>%
    mutate( location_id = ifelse(TypePQ == "PINK_PQ", str_c(as.character(grts_ranking), "_reloc", i), as.character(grts_ranking))) %>%
            #link_inboveg = str_c(grts_ranking, str_sub(Ftype, start = 2), sep = "_")) %>%
    select(-Ftype, -target, -TypePQ, -i) %>%
    distinct()

check <- n_distinct(admin_inbo_dunes$location_id) == nrow(admin_inbo_dunes) 

check_id <- admin_inbo_dunes %>%
    group_by(location_id) %>%
    mutate(n = n()) %>%
    ungroup()

```

### Combine

```{r}
admin_inbo <- bind_rows(
    admin_inbo_grassland_marshes_location,
    admin_inbo_dunes
)


```



## Read recorded data in plots assessed by INBO

```{r}

export <- "export_inboveg_2020-03-30"

classif_mhq <- read.csv2(str_c("../../n2khab_mhq_data/field-data/inboveg/", export, "/classif_mhq.csv"), stringsAsFactors = FALSE)
header_mhq <- read.csv2(str_c("../../n2khab_mhq_data/field-data/inboveg/", export, "/header_mhq.csv"), stringsAsFactors = FALSE)
vegetation_mhq <- read.csv2(str_c("../../n2khab_mhq_data/field-data/inboveg/", export, "/vegetation_mhq.csv"), stringsAsFactors = FALSE)
structure_mhq <- read.csv2(str_c("../../n2khab_mhq_data/field-data/inboveg/", export, "/structure_mhq.csv"), stringsAsFactors = FALSE)

#remove IV2020031607261542 because of double import --> OK
# 
# header_mhq <- header_mhq %>% 
#     filter(recording_givid != "IV2020031607261542")

```

## Check if assessments are complete


```{r}

types <- read_types()

coastal_dunes <- types %>%
    filter(typeclass_name %in% "Coastal sand dunes")

samples_grts <- read_vc(file = "mhq_terr_samples", root = "../../n2khab_mhq_data") %>%
    mutate(link_inboveg = ifelse(type %in% coastal_dunes$type, str_c(grts_ranking, "_", type), grts_ranking))

plots <- header_mhq %>%
  mutate(plot = ifelse(area == 1017 & !is.na(area), "circle", "square"),
         pos_temp = (str_locate(user_reference, "_"))[, "start"],
         grts_ranking = as.numeric(ifelse(is.na(pos_temp), user_reference, str_sub(user_reference, start = 1, end = pos_temp - 1))),
         link_inboveg = tolower(user_reference)
         #link_inboveg = ifelse(link_inboveg_temp %in% admin_inbo$link_inboveg, link_inboveg_temp, as.character(grts_ranking))
         ) %>%
  select(survey, recording_givid, plot, date = vague_date_begin, link_inboveg) %>%
  mutate(classif_rec_impored = recording_givid %in% classif_mhq$recording_givid,
         vegetation_rec_imported = recording_givid %in% vegetation_mhq$recording_givid,
         structure_rec_imported = ifelse(plot == "circle", recording_givid %in% structure_mhq$recording_givid, NA)) %>% 
  left_join(distinct(samples_grts, location_id, link_inboveg), by = "link_inboveg") %>%
    filter(!is.na(location_id))


```

### Check if circle plot and square plot is imported for each assessment

```{r}

check_plots <- plots %>%
    group_by(link_inboveg) %>%
    mutate(circle = "circle" %in% plot,
           square = "square" %in% plot) %>%
    ungroup() %>%
    filter((!square) | (!circle)) %>%
    filter(!is.na(link_inboveg)) %>%
    select(survey, recording_givid, date, link_inboveg, circle, square)

plots_not_complete <- str_c(check_plots$link_inboveg, collapse = ", ")

```

### Check if vegetation records are imported for ecah plot and structure records are imported for circle plot

```{r}

check_plots_data_import <- plots %>%
    filter((!vegetation_rec_imported) | (!structure_rec_imported)) %>%
    filter(!is.na(location_id))

write.table(check_plots_data_import, "../../output/check_plots_data_import.txt")

check_plots_data_import %>%
    kable() %>%
    kable_styling()
```



## Determine type in plot center and check if the observed type corresponds with the target type

The INBOVeg database contains assessment of habitat type cover within both the square plot and the circle plot. The field protocol prescribes that a plot is only recorded when the plot center is located within (one of) the target habitat type(s). When the observed type is different from (one of) the target type(s), the plot can be recorded when the GRTS ranking of the sample location is smaller than the largest GRTS ranking in the set of samples for the observed type. 

Some recorded plots contain different habitat types or other cover types. However it is not explicitely recorded which of the cover types is located in the center of the plot. Yet this is essential information to determine for which type the recorded data should be used in an analysis. Therefore, when a plot contains different cover types we assume that the plot center is located in the type recorded in the square plot that corresponds to (one of) the target type(s). When none of the target habitat types are observed we assume that the plot center is located in the type that belongs to the same main type as (one of) the target habitat types. We apply these rules and check of we select one type for each plot this way.


```{r}
segments <- plots %>%
  left_join(classif_mhq, by = c("recording_givid", "survey")) %>%
    mutate(type_observed = ifelse(type_observed %in% c("-9", "0"), "gh", type_observed)) %>%
    inner_join(select(samples_grts, location_id, sample_id, main_type, type), by = "location_id") %>%
    group_by(sample_id, plot, date) %>%
  mutate(type_cover_plot = str_c(str_c(str_replace_na(type_cover), "% ", type_observed), collapse =  " + ")) %>%
  ungroup() %>%
    mutate(type_observed = ifelse(type_observed == "6410" & main_type == "6410", as.character(type), type_observed),
           type_observed = ifelse(type_observed == "6230" & main_type == "6230", as.character(type), type_observed),
           type = ifelse(type == "6230" & str_sub(type_observed, 1, 4) == "6230", type_observed, as.character(type)),
           is_type_target = type_observed == type,
           is_main_type_target = str_sub(type_observed, 1, 4) == main_type) %>%
    group_by(location_id, plot, date) %>%
    mutate(is_type_target_plot = sum(is_type_target) > 0,
           is_main_type_target_plot = sum(is_main_type_target) > 0,
           n_habtarget = n_distinct(type),
           n_segments = n_distinct(type_observed)) %>%
    ungroup() 

# check plots with different observed types
segments_check <- segments %>%
    filter(n_segments > 1,
           plot == "square",
           ) %>%
    select(recording_givid, sample_id, plot_bevat_doelhabitat = is_type_target_plot, date, hab_target = type, type_observed, cover = type_cover, n_segments) %>%
    arrange(sample_id) %>%
    filter(hab_target != "6510_hu") %>%
    arrange(plot_bevat_doelhabitat) %>%
    filter(!plot_bevat_doelhabitat)

# check plots that are recorded more than once
segments_doubles_check <- segments %>%
    filter(plot == "square") %>%
    group_by(sample_id) %>%
    mutate(n_dates = n_distinct(date)) %>%
    ungroup() %>%
    filter(n_dates > 1) %>%
    distinct(recording_givid, location_id, date, type_observed, type_cover) %>%
    arrange(location_id)

# write.csv2(segments_check, "../../output/pq_mixed_cover.csv", row.names = FALSE)

# write.csv2(segments_doubles_check, "../../output/pq_dubbels.csv", row.names = FALSE)

# determine which segment contains the plot center
segments_center <- segments %>%
    filter(plot == "square") %>%
    mutate(segment_center = ifelse(n_segments <= 1 , TRUE,
                                   ifelse(is_type_target_plot, is_type_target, 
                                          ifelse(is_main_type_target_plot, is_main_type_target,
                                                 type_cover > 50)))) %>%
    distinct(date, location_id, type_observed, type_cover, segment_center, n_segments, n_habtarget, is_type_target_plot) %>% 
    group_by(location_id, date) %>%
           mutate(n_center = sum(segment_center, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(date = as.Date(date, format = "%Y-%m-%d"),
           assessment_year = as.numeric(format(date, "%Y"))) %>%
    filter(segment_center)
              
  
```

### Check if type cover is recorded

```{r}
check_type_cover <- segments %>%
    filter(is.na(type_cover)) %>%
    distinct(survey, link_inboveg, plot, type_cover_plot)
    
write.table(check_type_cover, "../../output/check_type_cover.txt")
```


```{r}

# cover description in square and circle plot
type_cover_wide <- segments %>%
    distinct(date, location_id,  plot, type_cover_plot) %>%
    spread(key = plot, value = type_cover_plot) %>%
    rename(type_cover_square = square, type_cover_circle = circle) %>%
    mutate(date = as.Date(date, format = "%Y-%m-%d"))

#maximum grts_ranking in sample for each type
max_ranking <- samples_grts %>%
    group_by(type, sac) %>%
    summarise(max_grts_ranking = max(grts_ranking)) %>%
    ungroup() %>%
    rename(type_observed = type)
    
#overview of assessed samples
# samples_admin_inbo_summary <- samples %>%
#     inner_join(admin_inbo, by = c("sample_id")) %>%
#     select(sample_id, grts_ranking, x, y, type, phab, sac, year_planned, assessment_status, assessment_year, measured, location_change, x_measured, y_measured) %>%
#     arrange(type, year_planned)

square_plots <- plots %>%
    filter(plot == "square")

assessment_inbo <- samples_grts %>%
    select(-link_inboveg) %>%
    filter(location_id %in% square_plots$location_id) %>%
    left_join(segments_center, by = c("location_id")) %>%
    mutate(type = ifelse(type == "6230" & str_sub(type_observed, 1, 4) == "6230", type_observed, as.character(type)),
           is_type_target = type == type_observed,
           assessment_year = as.numeric(format(date, "%Y"))) %>%
    left_join(type_cover_wide, by = c("location_id", "date")) %>%
    left_join(max_ranking, by = c("type_observed", "sac")) %>%
    mutate(allow_other_type = ifelse(is_type_target_plot, NA, grts_ranking <= max_grts_ranking)) %>%
    select(location_id, sample_id, grts_ranking, date_assessment = date, assessment_year, type_target = type, type_observed, type_observed_cover = type_cover, is_type_target, allow_other_type, type_cover_circle, type_cover_square, n_segments, n_habtarget, n_center, max_grts_ranking)

check_sample_id <- assessment_inbo %>%
    group_by(sample_id, date_assessment) %>%
    mutate(n = n()) %>%
    ungroup()

# only for samples in location 3276198 multiple records --> to do --> OK
```

### Check type in plot center

The plot with grts-ranking equal to 3276198 is selected for to target types and both target types are observed with each 50% cover, yet we do not know which of the types are located in the plot center. For all other plots only one type is selected as center based on the the assumptions described above. --> OK!

```{r}
assessment_inbo %>%
    filter(n_center != 1) %>%
    distinct(sample_id, grts_ranking, type_target, type_observed, type_observed_cover, n_center) -> check_plot_center 

write.csv2(check_plot_center, "../../output/check_plot_center.csv", row.names = FALSE)

check_plot_center %>%
    kable() %>%
    kable_styling() 

```

### Check cover of target type 

```{r}
assessment_inbo %>%
    filter(type_observed_cover < 50) %>%
    filter(is_type_target) %>%
    distinct(sample_id,  type_target, type_observed, type_observed_cover, type_cover_square, type_cover_circle) %>%
    arrange(type_observed_cover) -> check_cover_type_observed 

write.table(check_cover_type_observed, "../../output/check_cover_type_observed.txt", row.names = FALSE)

check_cover_type_observed %>%
    kable() %>%
    kable_styling() 
```

### Check measured plots not in database

```{r}

check_not_in_inboveg <- admin_inbo %>%
    filter(assessment_status == "in situ assessment") %>%
    filter(measured) %>%
    filter(assessment_year < 2019) %>%
    filter(!(location_id %in% assessment_inbo$location_id )) %>%
    left_join(select(samples_grts, sample_id, location_id, link_inboveg), by = "location_id")

write.csv2(check_not_in_inboveg, "../../output/check_not_in_database.csv", row.names = FALSE)

selected_samples <- str_c(check_not_in_inboveg$sample_id, collapse = ", ")

check_not_in_inboveg %>%
    kable() %>%
    kable_styling() 
```

## Combine admin and assessments

```{r}

sample_admin <- samples_grts %>%
    select(-link_inboveg) %>%
    left_join(admin_inbo, by = c("location_id", "grts_ranking")) %>%
    filter(!is.na(assessment_status))

check <- n_distinct(sample_admin$sample_id) == nrow(sample_admin)

sample_assessments <- sample_admin %>%
    left_join(assessment_inbo, by = c("sample_id", "location_id", "grts_ranking", "assessment_year"))

check <- n_distinct(sample_assessments$sample_id) == nrow(sample_assessments)
```



### Samples for which the position was changed but that does not contain the target type 

```{r}

check_location_change <- sample_assessments %>%
    filter(measured) %>%
    filter(allow_other_type) %>%
    filter(location_change) %>%
    select(sample_id, grts_ranking, type_target, type_observed, location_change) %>%
    arrange(grts_ranking)

check_location_change %>%
    kable %>%
    kable_styling()

```

### Samples for which the subtype of the observed type is unknown

```{r}

types <- types %>%
    group_by(main_type) %>%
    mutate(has_subtype = n() > 1) %>%
    ungroup()

subtypes <- types %>%
    filter(has_subtype)

check_subtype <- sample_assessments %>%
    filter(!is.na(type_observed)) %>%
    filter(type_observed %in% types$main_type) %>%
    filter(type_observed %in% subtypes$main_type)
```


## Read ANB admin data

```{r}

admin_anb_orig <- read.csv2("../../n2khab_mhq_data/original/admin/anb/PlotsMetDataAFGEWERKT.csv")

completed <- admin_anb_orig %>%
    select(location_id = IDPlots, afgewerkt = AFGEWERKT) %>%
    mutate(location_id = as.character(location_id)) %>%
    unique()


# admin_anb <- admin_anb_orig %>%
#     mutate(circleplot_measured = ifelse(!is.na(Sitedescr_6510), Sitedescr_6510,
#                                         ifelse(!is.na(Sitedescr_heide), Sitedescr_heide, NA))) %>%
#     select(id = SingleID, obs_circleplot = Hab_Standdesc, obs_vegplot = hab_VegPQ, vegplot_measured = VEGPQ, circleplot_measured, notes = opm_navplot) %>%
#     mutate(obs_vegplot = ifelse(obs_vegplot != "geen habitat (akker, houtkant, tuin,...)", 
#                                 str_replace(obs_vegplot, " ", "_"),
#                                 obs_vegplot),
#            obs_circleplot = ifelse(obs_circleplot != "geen habitat (akker, houtkant, tuin,...)", 
#                                 str_replace(obs_circleplot, " ", "_"),
#                                 obs_circleplot))

```


## Read recorded data in plots assessed by ANB

```{r}

export <- "export_fieldmap_2020-03-31"

cover_species <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/cover_species.csv"), stringsAsFactors = FALSE)
hab_observed <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/hab_observed.csv"), stringsAsFactors = FALSE)
measurements_6510_circle <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/measurements_6510_circle.csv"), stringsAsFactors = FALSE)
measurements_heath_circle <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/measurements_heath_circle.csv"), stringsAsFactors = FALSE)
measurements_square <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/measurements_square.csv"), stringsAsFactors = FALSE)
assessment_status <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/assessment_status.csv"), stringsAsFactors = FALSE)
observer_date <- read.csv2(str_c("../../n2khab_mhq_data/field-data/fieldmap/", export, "/observer_date.csv"), stringsAsFactors = FALSE)

```

## Read orthocontrole heath 

```{r}

heath_ortho_control_orig <- read_sf("../../n2khab_mhq_data/original/admin/anb", "meetnet_heide_versie20140611_orthocontrole") %>%
    st_drop_geometry()

admin_ortho_control <- heath_ortho_control_orig %>%
    filter(Orthocontr == 0) %>%
    mutate(location_id = as.character(Ranking),
           assessment_status = "orthophoto assessment",
           assessment_year = "2014",
           measured = FALSE) %>%
    distinct(location_id, assessment_status, assessment_year, measured) 
    
    
```




## Determine sample status

```{r}

observer_date <- observer_date %>%
     mutate(date = as.Date(date, format = "%Y-%m-%d"),
            location_id = as.character(plot_id)) %>%
    select(-plot_id) %>%
    unique()
   
admin_anb <- assessment_status %>%
    mutate(location_id = as.character(grts_ranking)) %>%
    left_join(observer_date, by = "location_id") %>%
    mutate(assessment_status = ifelse(status_fieldwork == "ja", "in situ assessment",
                                  ifelse(status_fieldwork == "nee", "no assessment", NA)),
           assessment_status = ifelse(!is.na(info_status_fieldwork) & info_status_fieldwork == "Geen opname : tijdelijk nt toeg", "temporary inaccessable", 
                                  ifelse(info_status_fieldwork %in% c("Geen opname : permanent nt toegankelijk", "Geen opname : geen toelating"), "permanently inaccessable", assessment_status)),
           measured = ifelse(assessment_status == "in situ assessment",
                                ifelse(!is.na(info_status_fieldwork) & info_status_fieldwork == "Geen opname : geen doelhabitat", FALSE, TRUE),
                                FALSE),
           completed = ifelse(measured,
                              ifelse(!is.na(info_status_fieldwork) &  info_status_fieldwork == "Geen (volledig) terreinbezoek uitgevoerd", FALSE, TRUE),
                              NA),
           assessment_year = format(date, "%Y"),
           location_change = ifelse(is.na(Remark), FALSE,
                                    str_detect( Remark, "verlegd"))) %>%
    distinct(location_id, assessment_status,  assessment_year, measured, completed, location_change) 

admin_ortho_control <- admin_ortho_control %>%
    filter(!(location_id %in% admin_anb$location_id)) 

admin_anb <- admin_anb %>%
    bind_rows(admin_ortho_control)

check <- n_distinct(admin_anb$location_id) == nrow(admin_anb)
    
check_n <- admin_anb %>%
    group_by(location_id) %>%
    mutate(n = n()) %>%
    ungroup()

```


## Type observed

```{r}

type_circle <- hab_observed %>% 
    mutate(location_id = as.character(plot_id),
           type_observed_circle = ifelse(type_observed_circle == "geen habitat (akker, houtkant, tuin,...)",
                                         "gh",
                                         type_observed_circle),
        type_observed_cover_circle = 100 * type_observed_cover_circle) %>%
    group_by(location_id) %>%
    summarise(type_cover_circle = str_c(str_c(str_replace_na(type_observed_cover_circle), "% ", type_observed_circle), collapse =  " + ")) %>%
    ungroup()

type_square <- measurements_square %>%
    mutate(location_id = as.character(plot_id),
           type_observed_square = ifelse(type_observed_square == "geen habitat (akker, houtkant, tuin,...)",
                                         "gh",
                                         type_observed_square)) %>%
    select(type_observed = type_observed_square, location_id) %>%
    unique() %>%
    mutate(type_cover_square = str_c("100% ", type_observed))
    
assessment_anb <- type_square %>%
    left_join(type_circle, by = "location_id") %>%
    left_join(select(samples_grts, sample_id, location_id, grts_ranking, type, sac), by = c("location_id")) %>%
    left_join(max_ranking, by = c("type_observed", "sac")) %>%
    rename(type_target = type) %>%
    mutate(type_observed = ifelse(is.na(type_observed) & !is.na(type_cover_circle),
                                  str_sub(type_cover_circle, start = 6),
                                  type_observed),
           is_type_target = type_target == type_observed,
           type_cover = 100) %>%
    filter(!is.na(type_observed)) %>%
    group_by(location_id) %>%
    mutate(is_type_target_plot = sum(is_type_target, na.rm = TRUE) > 0,
           n_habtarget = n_distinct(type_target)) %>%
    ungroup() %>%
    mutate(allow_other_type = ifelse(is_type_target_plot, NA, grts_ranking <= max_grts_ranking)) %>%
    select(location_id, sample_id, sac, grts_ranking, type_target, type_observed, type_observed_cover = type_cover, is_type_target, allow_other_type, type_cover_circle, type_cover_square, n_habtarget, max_grts_ranking)
    
check <- n_distinct(assessment_anb$sample_id) == nrow(assessment_anb)

```

## Combine admin and assessments

```{r}

main_type_anb <- c("6510", "4010", "4030", "2310", "2330")

samples_anb <- samples_grts %>%
    filter(main_type %in% main_type_anb)

locations_anb <- samples_grts %>%
    filter(location_id %in% samples_anb$location_id)

sample_admin_anb <- locations_anb %>%
    select(-link_inboveg) %>%
    left_join(admin_anb, by = c("location_id")) 

check <- n_distinct(sample_admin_anb$sample_id) == nrow(sample_admin_anb)

sample_assessments_anb <- sample_admin_anb %>%
    left_join(assessment_anb, by = c("sample_id", "location_id", "grts_ranking", "sac"))

check <- n_distinct(sample_assessments$sample_id) == nrow(sample_assessments)
```
