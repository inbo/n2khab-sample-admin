# Query fieldmap openhab

```{r}
combine_db <- function(db_new, db_old, by_var = "plot_id") {
    db_all <- db_old %>%
        anti_join(db_new, by = by_var) %>%
        bind_rows(db_new)
}

db_fieldmap_openhab_new <- "../../mhq_sample-admin_data/field-data/fieldmap/database_heath6510_2020-01-31/FieldMapData_NA2000.accdb"
db_fieldmap_openhab_old <- "../../mhq_sample-admin_data/field-data/fieldmap/database_heath6510_2018-06-11/FieldMapData_NA2000.accdb"
db_fieldmap_foresthab <- "../../mhq_sample-admin_data/field-data/fieldmap/database_forest_2020-06-04/FIELDMAPDATA_BOSHAB_F_V2020_QC202004.FDB"

# sample_status
sample_status_openhab <- combine_db(get_status_openhab(db_fieldmap_openhab_new),
                            get_status_openhab(db_fieldmap_openhab_old))

sample_status_foresthab <- get_status_foresthab()

sample_status <- bind_rows(sample_status_openhab, sample_status_foresthab)

check <- sample_status %>%
    group_by(plot_id) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

sample_status <- sample_status %>%
    group_by(plot_id, sampling_unit_code) %>%
    summarise(date_status = min(date_status),
              status_fieldwork = unique(status_fieldwork),
              info_status_fieldwork = unique(info_status_fieldwork),
              remark = str_c(remark, collapse = "+")) %>%
    ungroup()

# type_observed

type_observed <- combine_db(get_type_observed_openhab(db_fieldmap_openhab_new),
                                    get_type_observed_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_type_observed_foresthab())

# veglayers

cover_veglayers <- combine_db(get_cover_veglayers_openhab(db_fieldmap_openhab_new),
                                    get_cover_veglayers_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_cover_veglayers_foresthab())

#species

cover_species <- combine_db(get_cover_species_openhab(db_fieldmap_openhab_new),
                                    get_cover_species_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_cover_species_foresthab())



measurements_heath_circle_new  <- get_measurements_heath_circle() 
measurements_6510_circle_new  <- get_measurements_6510_circle()
observer_date_new  <- get_observation_date()
coordinates_new  <- get_coordinates()



sample_status_all <- get_status(db = db_fieldmap_open_hab_old) %>%
    anti_join(sample_status_new, by = "sample_id") %>%
    rbind(sample_status_new)

hab_observed_old <- get_observed_hab()
measurements_square_old  <- get_measurements_square()
cover_species_old  <- get_cover_species()
measurements_heath_circle_old  <- get_measurements_heath_circle() 
measurements_6510_circle_old  <- get_measurements_6510_circle()
observer_date_old  <- get_observation_date()
coordinates_old  <- get_coordinates()

#combine

sample_status <- rbind


setwd("../../n2khab_mhq_data/field-data/fieldmap/")
dir.create(as.character(str_c("export_fieldmap", as.character(Sys.Date(),"%Y-%m-%d"), sep = "_")))
setwd(str_c("export_fieldmap_", as.character(Sys.Date(),"%Y-%m-%d"), "/"))

write.csv2(sample_status, "sample_status.csv", row.names = FALSE)
write.csv2(hab_observed, "hab_observed.csv", row.names = FALSE)
write.csv2(measurements_square, "measurements_square.csv", row.names = FALSE)
write.csv2(cover_species, "cover_species.csv", row.names = FALSE)
write.csv2(measurements_heath_circle, "measurements_heath_circle.csv", row.names = FALSE)
write.csv2(measurements_6510_circle, "measurements_6510_circle.csv", row.names = FALSE)
write.csv2(observer_date, "observer_date.csv", row.names = FALSE)
write.csv2(coordinates, "coordinates.csv", row.names = FALSE)

```

