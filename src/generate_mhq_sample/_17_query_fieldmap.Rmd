# Query fieldmap openhab

```{r}
combine_db <- function(db_new, db_old, by_var = "plot_id") {
    db_all <- db_old %>%
        anti_join(db_new, by = by_var) %>%
        bind_rows(db_new)
}

db_fieldmap_openhab_new <- "../../mhq_sample-admin_data/field-data/fieldmap/database_heath6510_2020-01-31/FieldMapData_NA2000.accdb"
db_fieldmap_openhab_old <- "../../mhq_sample-admin_data/field-data/fieldmap/database_heath6510_2018-06-11/FieldMapData_NA2000.accdb"
db_fieldmap_foresthab <- "../../mhq_sample-admin_data/field-data/fieldmap/database_forest_2020-06-04/FIELDMAPDATA_BOSHAB_F_V2020_QC202004.FDB"

# sample_status
sample_status_openhab <- combine_db(get_status_openhab(db_fieldmap_openhab_new),
                            get_status_openhab(db_fieldmap_openhab_old))

sample_status_foresthab <- get_status_foresthab()

sample_status <- bind_rows(sample_status_openhab, sample_status_foresthab)

check <- sample_status %>%
    group_by(plot_id) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

sample_status <- sample_status %>%
    group_by(plot_id, sampling_unit_code) %>%
    summarise(date_status = min(date_status),
              status_fieldwork = unique(status_fieldwork),
              info_status_fieldwork = unique(info_status_fieldwork),
              remark = str_c(remark, collapse = "+")) %>%
    ungroup()

# type_observed

type_observed <- combine_db(get_type_observed_openhab(db_fieldmap_openhab_new),
                                    get_type_observed_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_type_observed_foresthab())

# veglayers

cover_veglayers <- combine_db(get_cover_veglayers_openhab(db_fieldmap_openhab_new),
                                    get_cover_veglayers_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_cover_veglayers_foresthab())

#species

cover_species <- combine_db(get_cover_species_openhab(db_fieldmap_openhab_new),
                                    get_cover_species_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_cover_species_foresthab())

# structure_vars

structure_vars_heath <-combine_db(get_measurements_heath_circle(db_fieldmap_openhab_new),
                                    get_measurements_heath_circle_old(db_fieldmap_openhab_old))
structure_vars_6510 <-combine_db(get_measurements_6510_circle(db_fieldmap_openhab_new),
                                    get_measurements_6510_circle(db_fieldmap_openhab_old))

structure_vars <- bind_rows(structure_vars_heath, structure_vars_6510)

# date

date_assessment_forest <- get_date_foresthab() %>%
    mutate(date_assessment = pmin(date_vegetation, date_dendro))

date_assessment <- combine_db(get_date_openhab(db_fieldmap_openhab_new),
                                    get_date_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(date_assessment_forest)

# coordinates

coordinates  <- combine_db(get_coordinates_openhab(db_fieldmap_openhab_new),
                                    get_coordinates_openhab(db_fieldmap_openhab_old)) %>%
    bind_rows(get_coordinates_foresthab())


setwd("../../mhq_sample-admin_data/field-data/fieldmap/")
dir.create(as.character(str_c("export_fieldmap", as.character(Sys.Date(),"%Y-%m-%d"), sep = "_")))
setwd(str_c("export_fieldmap_", as.character(Sys.Date(),"%Y-%m-%d"), "/"))

write.csv2(sample_status, "sample_status.csv", row.names = FALSE)
write.csv2(type_observed, "type_observed.csv", row.names = FALSE)
write.csv2(cover_veglayers, "cover_veglayers.csv", row.names = FALSE)
write.csv2(cover_species, "cover_species.csv", row.names = FALSE)
write.csv2(structure_vars, "structure_vars.csv", row.names = FALSE)
write.csv2(date_assessment, "date_assessment.csv", row.names = FALSE)
write.csv2(coordinates, "coordinates.csv", row.names = FALSE)

```

